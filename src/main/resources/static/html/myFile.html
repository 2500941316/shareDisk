<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>我的文件</title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    <meta name="author" content="Themesdesign"/>
    <link rel="stylesheet" href="../js/layui/css/layui.css" media="all">
    <script src="../js/head.js"></script>
    <style type="text/css">
        .layui-table-cell {
            height: 100%;
            max-width: 100%;
        }
    </style>
</head>

<body>


<!-- JOB LIST START -->
<section class="section pt-0">
    <div class="container">

        <div class="row justify-content-center">
            <div class="col-lg-9 text-center mt-4 pt-2">
                <ul class="nav nav-pills nav nav-pills bg-white rounded nav-justified flex-column flex-sm-row"
                    id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link rounded " href="#" id="back" data-toggle="pill"
                           onclick="callback()"
                           role="tab" aria-controls="recent-job" aria-selected="true">上一级</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link rounded" href="#" id="doc" data-toggle="pill"
                           onclick="getFilesByType('doc')"
                           role="tab" aria-controls="featured-job" aria-selected="false">文档</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link rounded" href="#" id="pic" data-toggle="pill"
                           onclick="getFilesByType('pic')"
                           role="tab"
                           aria-controls="part-job" aria-selected="false">图片</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link rounded" href="#" id="video" data-toggle="pill"
                           onclick="getFilesByType('video')" role="tab"
                           aria-controls="full-job" aria-selected="false">视频</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link rounded " href="#" id="new" data-toggle="pill"
                           onclick="buildDir()"
                           role="tab" aria-controls="full-job" aria-selected="false">新建文件夹</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link rounded active" href="#" id="all" data-toggle="pill"
                           onclick="getAllFile()"
                           role="tab" aria-controls="full-job" aria-selected="false">全部</a>
                    </li>
                </ul>
            </div>
        </div>


        <!--表格开始-->
        <!--layui-->
        <table class="layui-hide" id="test" lay-filter="test"></table>
        <script type="text/html" id="barDemo">

            <!--begin-->
            <div class="job-box bg-white overflow-hidden border rounded mt-4 position-relative overflow-hidden">
                <div class="lable text-center pt-2 pb-2">
                    <ul class="list-unstyled best text-white mb-0 text-uppercase">
                        <li class="list-inline-item"><i class="mdi mdi-star"></i></li>
                    </ul>
                </div>

                <div class="p-4">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="mo-mb-2">
                                <svg style="width: 35%;height: 50px;margin-left: 25px">
                                    <use xlink:href={{d.type}}></use>
                                </svg>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div>
                                <h6 class="f-18"><a href="#"
                                                    class="text-dark">{{d.name}}</a>
                                </h6>
                            </div>
                        </div>

                        <div class="col-md-1" style="text-align: center">
                            <div>
                                <p class="text-muted mb-0 mo-mb-2"><span
                                        class="text-primary">{{d.size}}</span>
                            </div>
                        </div>
                        <div class="col-md-2" style="text-align: center">
                            <div>
                                <p class="text-muted mb-0">{{d.time}}</p>
                            </div>
                        </div>
                        <div class="col-md-1" style="text-align: center">
                            <div>
                                <a lay-even="downLoad" class="text-primary">{{ d.dir == true ? '进入' : '下载' }} <i
                                        class="mdi mdi-chevron-double-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--一个文件端结束-->
        </script>

    </div>
</section>
<!-- JOB LIST START -->

<script>

    //点击新建文件夹按钮
    function buildDir() {
        alert("正在开发。。")
    }

    //查询文件夹或者回退的方法
    function selectFile(detSrc, type) {
        var table = layui.table;
        table.reload('test', {
            url: '/selectFile',
            where: {
                detSrc: detSrc,
                type: type,
                gId: ""
            },
            page: {
                curr: 1
            },
            done: function (res, curr, count) {
                //回调方法：如果类型为1，则将backid改成detSer，如果类型为0
                // ，则读取第一个文件的backid来作为现在的backid
                if (type === "1") {
                    localStorage.setItem("backid", detSrc);
                } else {
                    var newBack = res.data[0].back;
                    localStorage.setItem("backid", newBack);
                }
            }
        })
    }


    //返回上一级方法
    function callback() {
        var backid = localStorage.getItem("backid");
        if (backid.length > 8) {
            selectFile(backid, "0");
        } else {
            layui.use('layer', function () {
                layer.tips('已经是根目录', '#back', {
                    tips: 1
                });
            });
        }
    }

    //移除所有的竖导航栏的active
    function removeCur() {
        document.getElementById("pic").classList.remove("active");
        document.getElementById("doc").classList.remove("active");
        document.getElementById("video").classList.remove("active");
        document.getElementById("all").classList.remove("active");
    }


    //查询框查询文件名的方法
    function getFilesByType(type) {
        var table = layui.table;
        table.reload('test', {
            url: '/getFilesByType',
            where: {
                type: type
            },
            page: {
                curr: 1
            }
        })
        removeCur();
        document.getElementById(type).classList.add("active");
    }


    //查询全部文件
    function getAllFile() {
        selectFile(localStorage.getItem("userid"), "1");
        removeCur();
        document.getElementById("all").classList.add("active");
    }

    //文件大小转换
    function bytesToSize(bytes) {
        if (bytes === null || bytes === "") return "-";
        if (bytes === 0) return "0 B";
        var k = 1024;
        var sizes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toPrecision(3) + " " + sizes[i];
    }

    //时间戳转换
    function getDate(number) {
        var now = new Date(number),
            y = now.getFullYear(),
            m = now.getMonth() + 1,
            d = now.getDate();
        return (
            y +
            "-" +
            (m < 10 ? "0" + m : m) +
            "-" +
            (d < 10 ? "0" + d : d) +
            " " +
            now.toTimeString().substr(0, 5)
        );
    }


    //点击下载按钮的时候
    function downLoad(fileId) {
        //模拟表单提交
        var formHtml =
            "<form action='/downLoad' method='post' >";
        formHtml +=
            "<input type='hidden' name='fileId' value=" + fileId + " />";
        formHtml += "<input type='hidden' name='gId' value='' />";
        formHtml += "</form>";
        var form = $(formHtml);
        $(document.body).append(form);
        form.submit();
    }

    //给查询键绑定回车事件
    document.onkeydown = function (event) {
        var code = event.keyCode;
        if (code === 13) { //这是键盘的enter监听事件
            //绑定焦点，有可能不成功，需要多试试一些标签
            document.getElementById("submits").focus();
        }
    }


    //表格初始化值
    layui.use('table', function () {
        var table = layui.table;
        table.render({
            elem: '#test'
            , url: "/selectFile"
            , where: {
                detSrc: localStorage.getItem("userid"),
                type: "1",
                gId: ""
            }
            , limit: 8
            , page: {
                layout: ['count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                , groups: 3 //只显示 1 个连续页码
                , first: false //不显示首页
                , last: false //不显示尾页
            }
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据，res为从url中get到的数据
                var result;

                if (res.data !== null) {
                    if (this.page.curr) {
                        result = res.data.slice(this.limit * (this.page.curr - 1), this.limit * this.page.curr);
                    } else {
                        result = res.data.slice(0, this.limit);
                    }

                    //处理result的时间格式
                    for (var i = 0; i < result.length; i++) {
                        result[i].time = getDate(result[i].time);
                        result[i].type = peakPic(result[i].type);
                        result[i].size = bytesToSize(result[i].size);
                    }
                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": result //解析数据列表
                    };
                }

            }
            , cols: [[
                {toolbar: '#barDemo'}
            ]]
        });

        table.on('row(test)', function (obj) {
            var data = obj.data;
            layui.use('layer', function () {
                //如果不是文件夹，就下载
                if (!data.dir) {
                    layer.confirm('确认下载 ： ' + data.name, {
                        btn: ['确定', '取消']//按钮
                    }, function () {
                        downLoad(data.fileId);
                        layer.closeAll();
                    });
                } else { //如果是文件夹就重载表格
                    selectFile(data.fileId, "1");
                }
            });
        });
    })

</script>
<script src="../js/foot.js"></script>
</body>
</html>